<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Student Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .search-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .loading {
            display: none;
        }
        .pagination .page-link {
            color: #007bff;
        }
        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .table .badge {
            font-size: 0.9em;
        }
        .btn-suspend {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
        }
        .btn-unsuspend {
            background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);
            border: none;
            color: white;
        }
        .btn-suspend:hover {
            background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%);
            color: white;
        }
        .btn-unsuspend:hover {
            background: linear-gradient(135deg, #1e90ff 0%, #2ed573 100%);
            color: white;
        }
        .reason-cell {
            max-width: 150px;
            text-align: center;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Toast Container for Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Panel
                    </h1>
                    <p class="mb-0 mt-2">Student Management System - Administrative Control</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-users me-2"></i>
                        View Public Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Suspended Students Chart -->
        <div class="chart-container">
            <h4 class="chart-title">
                <i class="fas fa-chart-line me-2"></i>
                Suspended Students Comparison by Section
            </h4>
            <div style="position: relative; height: 400px;">
                <canvas id="suspendedChart"></canvas>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-box">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by name or roll number...">
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <select id="sectionFilter" class="form-select">
                        <option value="">All Sections</option>
                        <option value="A1">Section A1</option>
                        <option value="A2">Section A2</option>
                        <option value="A3">Section A3</option>
                        <option value="B1">Section B1</option>
                        <option value="B2">Section B2</option>
                        <option value="B3">Section B3</option>
                        <option value="C1">Section C1</option>
                        <option value="C2">Section C2</option>
                        <option value="C3">Section C3</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Students</option>
                        <option value="active">Active Only</option>
                        <option value="suspended">Suspended Only</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stats-card text-center">
                    <h3 id="totalStudents">0</h3>
                    <p class="mb-0">Total Students</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card text-center" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3 id="suspendedStudents">0</h3>
                    <p class="mb-0">Suspended Students</p>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading students...</p>
        </div>

        <!-- Students Table -->
        <div id="studentsContainer" class="mb-4">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Roll Number</th>
                        <th>Section</th>
                        <th>Batch</th>
                        <th>Status</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Students will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Suspension Reason Modal -->
        <div class="modal fade" id="suspensionModal" tabindex="-1" aria-labelledby="suspensionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="suspensionModalLabel">
                            <i class="fas fa-user-slash me-2"></i>
                            Suspend Student
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Student Name:</label>
                            <input type="text" class="form-control" id="studentName" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="studentRoll" class="form-label">Roll Number:</label>
                            <input type="text" class="form-control" id="studentRoll" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="suspensionReason" class="form-label">
                                <span class="text-danger">*</span> Suspension Reason:
                            </label>
                            <textarea class="form-control" id="suspensionReason" rows="4" 
                                placeholder="Please provide a detailed reason for suspending this student..." required></textarea>
                            <div class="form-text text-danger" id="reasonError" style="display: none;">
                                Suspension reason is required
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmSuspendBtn">
                            <i class="fas fa-user-slash me-2"></i>Confirm Suspension
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reason Details Modal -->
        <div class="modal fade" id="reasonDetailsModal" tabindex="-1" aria-labelledby="reasonDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reasonDetailsModalLabel">
                            <i class="fas fa-info-circle me-2"></i>
                            Suspension Reason Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Student Name:</label>
                            <p id="reasonStudentName" class="form-control-plaintext"></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Suspension Reason:</label>
                            <div class="border rounded p-3 bg-light" id="reasonDetails">
                                <!-- Reason details will be displayed here -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Students pagination">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="text-center mt-4" style="display: none;">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No students found</h4>
            <p class="text-muted">Try adjusting your search criteria</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allStudents = [];
        let filteredStudents = [];
        let currentPage = 1;
        const studentsPerPage = 50;
        let suspendedChart = null;
        let currentStudentId = null;
        let suspensionModal = null;
        let reasonDetailsModal = null;

        // API Base URL
        const API_BASE = 'http://localhost:5000/api';

        // Load students on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            setupEventListeners();
            initializeChart();
            initializeModal();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(filterStudents, 300));
            document.getElementById('sectionFilter').addEventListener('change', filterStudents);
            document.getElementById('statusFilter').addEventListener('change', filterStudents);
            
            // Setup modal event listeners
            document.getElementById('confirmSuspendBtn').addEventListener('click', confirmSuspension);
            document.getElementById('suspensionReason').addEventListener('input', hideReasonError);
            
            // Setup event delegation for view reason buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-reason-btn')) {
                    const button = e.target.closest('.view-reason-btn');
                    const studentName = button.getAttribute('data-student-name');
                    const reason = button.getAttribute('data-reason');
                    showReasonDetails(studentName, reason);
                }
            });
        }

        async function loadStudents() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/students`);
                const data = await response.json();
                
                if (data.success) {
                    allStudents = data.students;
                    filteredStudents = [...allStudents];
                    updateStatistics();
                    updateChart();
                    displayStudents();
                } else {
                    showError('Failed to load students');
                }
            } catch (error) {
                showError('Error connecting to server');
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sectionFilter = document.getElementById('sectionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredStudents = allStudents.filter(student => {
                const matchesSearch = !searchTerm || 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.rollNumber.toLowerCase().includes(searchTerm);
                const matchesSection = !sectionFilter || student.section === sectionFilter;
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !student.isSuspended;
                } else if (statusFilter === 'suspended') {
                    matchesStatus = student.isSuspended;
                }
                return matchesSearch && matchesSection && matchesStatus;
            });

            currentPage = 1;
            displayStudents();
        }

        function displayStudents() {
            const tableBody = document.getElementById('studentsTableBody');
            const noResults = document.getElementById('noResults');
            
            if (filteredStudents.length === 0) {
                tableBody.innerHTML = '';
                noResults.style.display = 'block';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            noResults.style.display = 'none';

            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const currentStudents = filteredStudents.slice(startIndex, endIndex);

            tableBody.innerHTML = currentStudents.map(student => `
                <tr class="${student.isSuspended ? 'table-danger' : ''}">
                    <td>${student.name}</td>
                    <td>${student.rollNumber}</td>
                    <td>${student.section}</td>
                    <td>${student.batch}</td>
                    <td>
                        <span class="badge ${student.isSuspended ? 'bg-danger' : 'bg-success'}">
                            ${student.isSuspended ? 'Suspended' : 'Active'}
                        </span>
                    </td>
                    <td class="reason-cell">
                        ${student.isSuspended && student.reason ? 
                            `<button class="btn btn-outline-info btn-sm view-reason-btn" data-student-name="${student.name.replace(/"/g, '&quot;')}" data-reason="${student.reason.replace(/"/g, '&quot;')}">
                                <i class="fas fa-eye me-1"></i>View Reason
                            </button>` : 
                            '<span class="text-muted">-</span>'
                        }
                    </td>
                    <td>
                        ${student.isSuspended ? 
                            `<button class="btn btn-unsuspend btn-sm" onclick="unsuspendStudent(${student.id})">
                                <i class="fas fa-user-check me-1"></i>Unsuspend
                            </button>` :
                            `<button class="btn btn-suspend btn-sm" onclick="showSuspensionModal(${student.id}, '${student.name}', '${student.rollNumber}')">
                                <i class="fas fa-user-slash me-1"></i>Suspend
                            </button>`
                        }
                    </td>
                </tr>
            `).join('');

            updatePagination();
        }

        async function suspendStudent(studentId, reason) {
            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/suspend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Student suspended successfully!', 'success');
                    await loadStudents();
                } else {
                    showToast(data.error || 'Failed to suspend student', 'error');
                }
            } catch (error) {
                showToast('Error suspending student', 'error');
                console.error('Error:', error);
            }
        }

        async function unsuspendStudent(studentId) {
            // Find the student to get their reason
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            let confirmMessage = 'Are you sure you want to unsuspend this student?';
            if (student.reason) {
                confirmMessage += `\n\nCurrent suspension reason: ${student.reason}`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/students/${studentId}/unsuspend`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Student unsuspended successfully!', 'success');
                    await loadStudents();
                } else {
                    showToast(data.error || 'Failed to unsuspend student', 'error');
                }
            } catch (error) {
                showToast('Error unsuspending student', 'error');
                console.error('Error:', error);
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayStudents();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateStatistics() {
            const total = allStudents.length;
            const suspended = allStudents.filter(s => s.isSuspended).length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('suspendedStudents').textContent = suspended;
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 'bg-info';
            
            const toastHTML = `
                <div class="toast show ${bgClass} text-white" id="${toastId}" role="alert">
                    <div class="toast-header ${bgClass} text-white">
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            setTimeout(() => {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.remove();
                }
            }, 3000);
        }

        function initializeModal() {
            console.log('Initializing modals...');
            try {
                suspensionModal = new bootstrap.Modal(document.getElementById('suspensionModal'));
                reasonDetailsModal = new bootstrap.Modal(document.getElementById('reasonDetailsModal'));
                console.log('Modals initialized successfully:', { suspensionModal, reasonDetailsModal });
            } catch (error) {
                console.error('Error initializing modals:', error);
            }
        }

        function showSuspensionModal(studentId, studentName, studentRoll) {
            currentStudentId = studentId;
            document.getElementById('studentName').value = studentName;
            document.getElementById('studentRoll').value = studentRoll;
            document.getElementById('suspensionReason').value = '';
            document.getElementById('reasonError').style.display = 'none';
            suspensionModal.show();
        }

        function hideReasonError() {
            document.getElementById('reasonError').style.display = 'none';
        }

        function confirmSuspension() {
            const reason = document.getElementById('suspensionReason').value.trim();
            
            if (!reason) {
                document.getElementById('reasonError').style.display = 'block';
                return;
            }
            
            if (currentStudentId) {
                suspensionModal.hide();
                suspendStudent(currentStudentId, reason);
            }
        }

        function showReasonDetails(studentName, reason) {
            console.log('showReasonDetails called with:', studentName, reason);
            console.log('reasonDetailsModal:', reasonDetailsModal);
            
            if (!reasonDetailsModal) {
                console.error('Modal not initialized!');
                return;
            }
            
            try {
                document.getElementById('reasonStudentName').textContent = studentName;
                document.getElementById('reasonDetails').textContent = reason;
                reasonDetailsModal.show();
                console.log('Modal should be showing now');
            } catch (error) {
                console.error('Error showing modal:', error);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function initializeChart() {
            const ctx = document.getElementById('suspendedChart').getContext('2d');
            suspendedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3'],
                    datasets: [{
                        label: 'Suspended Students',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(255, 99, 132)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `Suspended Students: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 12
                                },
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Suspended Students',
                                color: '#333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Sections',
                                color: '#333',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function updateChart() {
            if (!suspendedChart) return;

            const sections = ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3'];
            const suspendedCounts = sections.map(section => {
                return allStudents.filter(student => 
                    student.section === section && student.isSuspended
                ).length;
            });

            suspendedChart.data.datasets[0].data = suspendedCounts;
            suspendedChart.update('active');
        }
    </script>
</body>
</html>